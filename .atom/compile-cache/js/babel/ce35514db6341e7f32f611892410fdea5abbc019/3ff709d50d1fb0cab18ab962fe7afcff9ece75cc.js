"use babel";

Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.activate = activate;
exports.deactivate = deactivate;
exports.handleURI = handleURI;
exports.deserialize = deserialize;
var path = null;
var PdfEditorView = null;
var querystring = null;
var subscriptions = null;

var _require = require('atom');

var CompositeDisposable = _require.CompositeDisposable;

function activate(state) {
  subscriptions = new CompositeDisposable(atom.workspace.addOpener(openUri), atom.packages.onDidActivateInitialPackages(createPdfStatusView), atom.config.observe('pdf-view.fileExtensions', updateFileExtensions), atom.commands.add('atom-workspace', 'pdf-view:toggle-binary-view', toggleBinaryView));
}

function deactivate() {
  if (subscriptions) {
    subscriptions.dispose();
  }
}

function handleURI(parsedUri) {
  var query = Object.assign({}, parsedUri.query);

  if (parsedUri.hash) {
    // Allow query parameters to exist in hash to main compatability with Adobe
    // PDF style urls.
    if (parsedUri.hash.includes('=')) {
      if (querystring === null) {
        querystring = require('querystring');
      }

      Object.assign(query, querystring.parse(parsedUri.hash.substring(1)));
    } else {
      query.nameddest = parsedUri.hash.substring(1);
    }
  }

  var filePath = query.path || pathnameToFilePath(parsedUri.pathname);

  atom.workspace.open(filePath).then(function (view) {
    if (view) {
      if (query.source && query.line) {
        view.forwardSync(query.source, query.line);
      } else if (query.page) {
        view.scrollToPage(query.page);
      } else if (query.nameddest) {
        view.scrollToNamedDest(query.nameddest);
      }
    }
  });
}

function pathnameToFilePath(pathname) {
  var filePath = decodeURI(pathname || '');

  if (process.platform === 'win32') {
    filePath = filePath.replace(/\//g, '\\').replace(/^(.+)\|/, '$1:').replace(/\\([A-Z]:\\)/, '$1');
  } else if (!filePath.startsWith('/')) {
    filePath = '/' + filePath;
  }

  return filePath;
}

// Files with these extensions will be opened as PDFs
var pdfExtensions = new Set();

function updateFileExtensions(extensions) {
  pdfExtensions.clear();
  for (var extension of extensions) {
    extension = extension.toLowerCase().replace(/^\.*/, '.');
    pdfExtensions.add(extension);
  }
}

function openUri(uriToOpen) {
  if (path === null) {
    path = require('path');
  }

  var uriExtension = path.extname(uriToOpen).toLowerCase();
  if (pdfExtensions.has(uriExtension)) {
    if (PdfEditorView === null) {
      PdfEditorView = require('./pdf-editor-view');
    }
    return new PdfEditorView(uriToOpen);
  }
}

function toggleBinaryView() {
  if (PdfEditorView === null) {
    PdfEditorView = require('./pdf-editor-view');
  }
  var paneItem = atom.workspace.getActivePaneItem();
  if (!paneItem || !(paneItem instanceof PdfEditorView)) {
    return;
  }
  paneItem.binaryView = !paneItem.binaryView;
}

function createPdfStatusView() {
  var PdfStatusBarView = require('./pdf-status-bar-view');
  new PdfStatusBarView();
  var PdfGoToPageView = require('./pdf-goto-page-view');
  new PdfGoToPageView();
}

function deserialize(_ref) {
  var filePath = _ref.filePath;
  var scale = _ref.scale;
  var scrollTop = _ref.scrollTop;
  var scrollLeft = _ref.scrollLeft;

  if (require('fs-plus').isFileSync(filePath)) {
    if (PdfEditorView === null) {
      PdfEditorView = require('./pdf-editor-view');
    }
    return new PdfEditorView(filePath, scale, scrollTop, scrollLeft);
  } else {
    console.warn("Could not deserialize PDF editor for path '#{filePath}' because that file no longer exists");
  }
}

if (parseFloat(atom.getVersion()) < 1.7) {
  atom.deserializers.add({
    "name": "PdfEditorDeserializer",
    "deserialize": deserialize
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3lva290YS8uYXRvbS9wYWNrYWdlcy9wZGYtdmlldy9saWIvcGRmLWVkaXRvci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxXQUFXLENBQUM7Ozs7Ozs7OztBQUVaLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztBQUNoQixJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUM7QUFDekIsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDO0FBQ3ZCLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQzs7ZUFDSyxPQUFPLENBQUMsTUFBTSxDQUFDOztJQUF0QyxtQkFBbUIsWUFBbkIsbUJBQW1COztBQUVuQixTQUFTLFFBQVEsQ0FBQyxLQUFLLEVBQUU7QUFDOUIsZUFBYSxHQUFHLElBQUksbUJBQW1CLENBQ3JDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxFQUNqQyxJQUFJLENBQUMsUUFBUSxDQUFDLDRCQUE0QixDQUFDLG1CQUFtQixDQUFDLEVBQy9ELElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLHlCQUF5QixFQUFFLG9CQUFvQixDQUFDLEVBQ3BFLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLDZCQUE2QixFQUFFLGdCQUFnQixDQUFDLENBQ3JGLENBQUM7Q0FDSDs7QUFFTSxTQUFTLFVBQVUsR0FBRztBQUMzQixNQUFJLGFBQWEsRUFBRTtBQUNqQixpQkFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDO0dBQ3pCO0NBQ0Y7O0FBRU0sU0FBUyxTQUFTLENBQUMsU0FBUyxFQUFFO0FBQ25DLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQTs7QUFFaEQsTUFBSSxTQUFTLENBQUMsSUFBSSxFQUFFOzs7QUFHbEIsUUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtBQUNoQyxVQUFJ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Q0Y7O0FBRUQsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFO0FBQ3ZDLE1BQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDO0FBQ3JCLFVBQU0sRUFBRSx1QkFBdUI7QUFDL0IsaUJBQWEsRUFBRSxXQUFXO0dBQzNCLENBQUMsQ0FBQztDQUNKIiwiZmlsZSI6Ii9ob21lL3lva290YS8uYXRvbS9wYWNrYWdlcy9wZGYtdmlldy9saWIvcGRmLWVkaXRvci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIGJhYmVsXCI7XG5cbmxldCBwYXRoID0gbnVsbDtcbmxldCBQZGZFZGl0b3JWaWV3ID0gbnVsbDtcbmxldCBxdWVyeXN0cmluZyA9IG51bGw7XG5sZXQgc3Vic2NyaXB0aW9ucyA9IG51bGw7XG5jb25zdCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gPSByZXF1aXJlKCdhdG9tJyk7XG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZShzdGF0ZSkge1xuICBzdWJzY3JpcHRpb25zID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoXG4gICAgYXRvbS53b3Jrc3BhY2UuYWRkT3BlbmVyKG9wZW5VcmkpLFxuICAgIGF0b20ucGFja2FnZXMub25EaWRBY3RpdmF0ZUluaXRpYWxQYWNrYWdlcyhjcmVhdGVQZGZTdGF0dXNWaWV3KSxcbiAgICBhdG9tLmNvbmZpZy5vYnNlcnZlKCdwZGYtdmlldy5maWxlRXh0ZW5zaW9ucycsIHVwZGF0ZUZpbGVFeHRlbnNpb25zKSxcbiAgICBhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS13b3Jrc3BhY2UnLCAncGRmLXZpZXc6dG9nZ2xlLWJpbmFyeS12aWV3JywgdG9nZ2xlQmluYXJ5VmlldylcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlYWN0aXZhdGUoKSB7XG4gIGlmIChzdWJzY3JpcHRpb25zKSB7XG4gICAgc3Vic2NyaXB0aW9ucy5kaXNwb3NlKCk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhbmRsZVVSSShwYXJzZWRVcmkpIHtcbiAgY29uc3QgcXVlcnkgPSBPYmplY3QuYXNzaWduKHt9LCBwYXJzZWRVcmkucXVlcnkpXG5cbiAgaWYgKHBhcnNlZFVyaS5oYXNoKSB7XG4gICAgLy8gQWxsb3cgcXVlcnkgcGFyYW1ldGVycyB0byBleGlzdCBpbiBoYXNoIHRvIG1haW4gY29tcGF0YWJpbGl0eSB3aXRoIEFkb2JlXG4gICAgLy8gUERGIHN0eWxlIHVybHMuXG4gICAgaWYgKHBhcnNlZFVyaS5oYXNoLmluY2x1ZGVzKCc9JykpIHtcbiAgICAgIGlmIChxdWVyeXN0cmluZyA9PT0gbnVsbCkge1xuICAgICAgICBxdWVyeXN0cmluZyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nJylcbiAgICAgIH1cblxuICAgICAgT2JqZWN0LmFzc2lnbihxdWVyeSwgcXVlcnlzdHJpbmcucGFyc2UocGFyc2VkVXJpLmhhc2guc3Vic3RyaW5nKDEpKSlcbiAgICB9IGVsc2Uge1xuICAgICAgcXVlcnkubmFtZWRkZXN0ID0gcGFyc2VkVXJpLmhhc2guc3Vic3RyaW5nKDEpXG4gICAgfVxuICB9XG5cbiAgY29uc3QgZmlsZVBhdGggPSBxdWVyeS5wYXRoIHx8IHBhdGhuYW1lVG9GaWxlUGF0aChwYXJzZWRVcmkucGF0aG5hbWUpXG5cbiAgYXRvbS53b3Jrc3BhY2Uub3BlbihmaWxlUGF0aCkudGhlbih2aWV3ID0+IHtcbiAgICBpZiAodmlldykge1xuICAgICAgaWYgKHF1ZXJ5LnNvdXJjZSAmJiBxdWVyeS5saW5lKSB7XG4gICAgICAgIHZpZXcuZm9yd2FyZFN5bmMocXVlcnkuc291cmNlLCBxdWVyeS5saW5lKVxuICAgICAgfSBlbHNlIGlmIChxdWVyeS5wYWdlKSB7XG4gICAgICAgIHZpZXcuc2Nyb2xsVG9QYWdlKHF1ZXJ5LnBhZ2UpXG4gICAgICB9IGVsc2UgaWYgKHF1ZXJ5Lm5hbWVkZGVzdCkge1xuICAgICAgICB2aWV3LnNjcm9sbFRvTmFtZWREZXN0KHF1ZXJ5Lm5hbWVkZGVzdClcbiAgICAgIH1cbiAgICB9XG4gIH0pXG59XG5cbmZ1bmN0aW9uIHBhdGhuYW1lVG9GaWxlUGF0aChwYXRobmFtZSkge1xuICBsZXQgZmlsZVBhdGggPSBkZWNvZGVVUkkocGF0aG5hbWUgfHwgJycpXG5cbiAgaWYgKHByb2Nlc3MucGxhdGZvcm0gPT09ICd3aW4zMicpIHtcbiAgICBmaWxlUGF0aCA9IGZpbGVQYXRoLnJlcGxhY2UoL1xcLy9nLCAnXFxcXCcpLnJlcGxhY2UoL14oLispXFx8LywgJyQxOicpLnJlcGxhY2UoL1xcXFwoW0EtWl06XFxcXCkvLCAnJDEnKVxuICB9IGVsc2UgaWYgKCFmaWxlUGF0aC5zdGFydHNXaXRoKCcvJykpIHtcbiAgICBmaWxlUGF0aCA9IGAvJHtmaWxlUGF0aH1gXG4gIH1cblxuICByZXR1cm4gZmlsZVBhdGhcbn1cblxuLy8gRmlsZXMgd2l0aCB0aGVzZSBleHRlbnNpb25zIHdpbGwgYmUgb3BlbmVkIGFzIFBERnNcbmNvbnN0IHBkZkV4dGVuc2lvbnMgPSBuZXcgU2V0KCk7XG5cbmZ1bmN0aW9uIHVwZGF0ZUZpbGVFeHRlbnNpb25zKGV4dGVuc2lvbnMpIHtcbiAgcGRmRXh0ZW5zaW9ucy5jbGVhcigpO1xuICBmb3IgKGxldCBleHRlbnNpb24gb2YgZXh0ZW5zaW9ucykge1xuICAgIGV4dGVuc2lvbiA9IGV4dGVuc2lvbi50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL15cXC4qLywgJy4nKTtcbiAgICBwZGZFeHRlbnNpb25zLmFkZChleHRlbnNpb24pO1xuICB9XG59XG5cbmZ1bmN0aW9uIG9wZW5VcmkodXJpVG9PcGVuKSB7XG4gIGlmIChwYXRoID09PSBudWxsKSB7XG4gICAgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbiAgfVxuXG4gIGxldCB1cmlFeHRlbnNpb24gPSBwYXRoLmV4dG5hbWUodXJpVG9PcGVuKS50b0xvd2VyQ2FzZSgpXG4gIGlmIChwZGZFeHRlbnNpb25zLmhhcyh1cmlFeHRlbnNpb24pKSB7XG4gICAgaWYgKFBkZkVkaXRvclZpZXcgPT09IG51bGwpIHtcbiAgICAgIFBkZkVkaXRvclZpZXcgPSByZXF1aXJlKCcuL3BkZi1lZGl0b3ItdmlldycpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFBkZkVkaXRvclZpZXcodXJpVG9PcGVuKTtcbiAgfVxufVxuXG5mdW5jdGlvbiB0b2dnbGVCaW5hcnlWaWV3KCkge1xuICBpZihQZGZFZGl0b3JWaWV3ID09PSBudWxsKSB7XG4gICAgUGRmRWRpdG9yVmlldyA9IHJlcXVpcmUoJy4vcGRmLWVkaXRvci12aWV3Jyk7XG4gIH1cbiAgY29uc3QgcGFuZUl0ZW0gPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVQYW5lSXRlbSgpO1xuICBpZighcGFuZUl0ZW0gfHwgIShwYW5lSXRlbSBpbnN0YW5jZW9mIFBkZkVkaXRvclZpZXcpKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIHBhbmVJdGVtLmJpbmFyeVZpZXcgPSAhcGFuZUl0ZW0uYmluYXJ5Vmlldztcbn1cblxuZnVuY3Rpb24gY3JlYXRlUGRmU3RhdHVzVmlldygpIHtcbiAgbGV0IFBkZlN0YXR1c0JhclZpZXcgPSByZXF1aXJlKCcuL3BkZi1zdGF0dXMtYmFyLXZpZXcnKTtcbiAgbmV3IFBkZlN0YXR1c0JhclZpZXcoKTtcbiAgbGV0IFBkZkdvVG9QYWdlVmlldyA9IHJlcXVpcmUoJy4vcGRmLWdvdG8tcGFnZS12aWV3Jyk7XG4gIG5ldyBQZGZHb1RvUGFnZVZpZXcoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlc2VyaWFsaXplKHtmaWxlUGF0aCwgc2NhbGUsIHNjcm9sbFRvcCwgc2Nyb2xsTGVmdH0pIHtcbiAgaWYgKHJlcXVpcmUoJ2ZzLXBsdXMnKS5pc0ZpbGVTeW5jKGZpbGVQYXRoKSkge1xuICAgIGlmIChQZGZFZGl0b3JWaWV3ID09PSBudWxsKSB7XG4gICAgICBQZGZFZGl0b3JWaWV3ID0gcmVxdWlyZSgnLi9wZGYtZWRpdG9yLXZpZXcnKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBQZGZFZGl0b3JWaWV3KGZpbGVQYXRoLCBzY2FsZSwgc2Nyb2xsVG9wLCBzY3JvbGxMZWZ0KTtcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlLndhcm4oXCJDb3VsZCBub3QgZGVzZXJpYWxpemUgUERGIGVkaXRvciBmb3IgcGF0aCAnI3tmaWxlUGF0aH0nIGJlY2F1c2UgdGhhdCBmaWxlIG5vIGxvbmdlciBleGlzdHNcIik7XG4gIH1cbn1cblxuaWYgKHBhcnNlRmxvYXQoYXRvbS5nZXRWZXJzaW9uKCkpIDwgMS43KSB7XG4gIGF0b20uZGVzZXJpYWxpemVycy5hZGQoe1xuICAgIFwibmFtZVwiOiBcIlBkZkVkaXRvckRlc2VyaWFsaXplclwiLFxuICAgIFwiZGVzZXJpYWxpemVcIjogZGVzZXJpYWxpemVcbiAgfSk7XG59XG4iXX0=